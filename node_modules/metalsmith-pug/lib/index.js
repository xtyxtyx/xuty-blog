'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

exports.default = function () {
  var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
      _ref$locals = _ref.locals,
      locals = _ref$locals === undefined ? {} : _ref$locals,
      _ref$filters = _ref.filters,
      filters = _ref$filters === undefined ? {} : _ref$filters,
      _ref$useMetadata = _ref.useMetadata,
      useMetadata = _ref$useMetadata === undefined ? false : _ref$useMetadata;

  var opts = arguments[0] || {};

  return function (files, metalsmith, done) {
    setImmediate(done);

    // extend with metalsmith global metadata
    if (useMetadata) {
      locals = _extends(locals, metalsmith.metadata());
    }

    Object.keys(files).forEach(function (file) {
      if (!/\.(pug|jade)/.test(_path2.default.extname(file))) {
        return;
      }

      var data = files[file];
      var dir = _path2.default.dirname(file);
      var name = _path2.default.basename(file, _path2.default.extname(file));

      // do we need to add an extension?
      if (_path2.default.extname(name) === '') {
        name = _path2.default.basename(file, _path2.default.extname(file)) + '.html';
      }

      if (dir !== '.') {
        name = dir + '/' + name;
      }

      var filename = _path2.default.join(metalsmith.source(), file);

      // also use the file's own data
      if (useMetadata) {
        locals = _extends(locals, data);
      }

      // assign filters
      if (filters) {
        Object.keys(filters).forEach(function (filter) {
          return _pug2.default.filters[filter] = filters[filter];
        });
      }

      var options = _extends(opts, {
        filename: filename,
        locals: locals
      });

      // render
      var str = _pug2.default.compile(data.contents.toString(), options)(locals);

      // convert to a buffer
      data.contents = new Buffer(str);

      // remove from global files object
      delete files[file];

      // assign the newly created file
      files[name] = data;
    });
  };
};

var _pug = require('pug');

var _pug2 = _interopRequireDefault(_pug);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

module.exports = exports['default'];